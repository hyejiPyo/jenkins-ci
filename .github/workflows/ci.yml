name: Secure Build & Notify Jenkins

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  secure-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run tfsec (Terraform security scan)
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          path: .

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Build project for CodeQL
        run: ./gradlew build --no-daemon

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # -------------------------------
      # Dependency Review (SCA)
      # -------------------------------
      - name: Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4
        with:
          base_ref: ${{ github.event.pull_request.base.ref }}
          head_ref: ${{ github.event.pull_request.head.ref }}

      # -------------------------------
      # Jenkins 빌드 트리거 (보안 검사 통과 후)
      # -------------------------------
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Notify Jenkins via Webhook
        if: success() # 보안 검사 성공시에만 트리거
        env:
          JENKINS_API_TOKEN: ${{ secrets.JENKINS_API_TOKEN }}
        run: |
          CRUMB=$(curl -s --user "admin:${JENKINS_API_TOKEN}" 'http://34.22.89.44:8080/crumbIssuer/api/json' | jq -r '.crumbRequestField + ":" + .crumb')
          curl -X POST "http://34.22.89.44:8080/generic-webhook-trigger/invoke" \
            -H "$CRUMB" \
            --user "admin:${JENKINS_API_TOKEN}" \
            --data "token=my-webhook-secret" \
            --data-urlencode "GIT_BRANCH=main"
